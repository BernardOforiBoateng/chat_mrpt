<script>
    // Message search functionality
    const searchBtn = document.getElementById('searchMessagesBtn');
    const searchInput = document.getElementById('messageSearchInput');
    const userMessagesOnly = document.getElementById('userMessagesOnly');
    const aiMessagesOnly = document.getElementById('aiMessagesOnly');
    const systemMessagesOnly = document.getElementById('systemMessagesOnly');
    
    if (searchBtn && searchInput) {
        searchBtn.addEventListener('click', searchMessages);
        searchInput.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                searchMessages();
            }
        });
        
        // Make message type checkboxes mutually exclusive
        if (userMessagesOnly) {
            userMessagesOnly.addEventListener('change', function() {
                if (this.checked) {
                    if (aiMessagesOnly) aiMessagesOnly.checked = false;
                    if (systemMessagesOnly) systemMessagesOnly.checked = false;
                }
                searchMessages();
            });
        }
        
        if (aiMessagesOnly) {
            aiMessagesOnly.addEventListener('change', function() {
                if (this.checked) {
                    if (userMessagesOnly) userMessagesOnly.checked = false;
                    if (systemMessagesOnly) systemMessagesOnly.checked = false;
                }
                searchMessages();
            });
        }
        
        if (systemMessagesOnly) {
            systemMessagesOnly.addEventListener('change', function() {
                if (this.checked) {
                    if (userMessagesOnly) userMessagesOnly.checked = false;
                    if (aiMessagesOnly) aiMessagesOnly.checked = false;
                }
                searchMessages();
            });
        }
    }
    
    function searchMessages() {
        if (!searchInput) return;
        
        const searchTerm = searchInput.value.toLowerCase();
        const messageElements = document.querySelectorAll('#messageList > div');
        let visibleCount = 0;
        
        // Remove all existing highlights
        document.querySelectorAll('.message-search-highlight').forEach(el => {
            const parent = el.parentNode;
            parent.replaceChild(document.createTextNode(el.textContent), el);
        });
        
        messageElements.forEach(message => {
            // Apply sender filter first
            let showBySender = true;
            if (userMessagesOnly && userMessagesOnly.checked && message.getAttribute('data-sender') !== 'user') {
                showBySender = false;
            }
            if (aiMessagesOnly && aiMessagesOnly.checked && message.getAttribute('data-sender') !== 'assistant') {
                showBySender = false;
            }
            if (systemMessagesOnly && systemMessagesOnly.checked && message.getAttribute('data-sender') !== 'system') {
                showBySender = false;
            }
            
            // Then apply text search
            const content = message.querySelector('.content');
            if (!content) return;
            
            const text = content.textContent.toLowerCase();
            
            if (showBySender && (searchTerm === '' || text.includes(searchTerm))) {
                message.style.display = '';
                visibleCount++;
                
                // Add highlight if search term is not empty
                if (searchTerm !== '') {
                    highlightText(content, searchTerm);
                }
            } else {
                message.style.display = 'none';
            }
        });
        
        // Add a status message if needed
        const existingStatus = document.getElementById('searchStatusMessage');
        if (existingStatus) {
            existingStatus.remove();
        }
        
        if (searchTerm !== '' || (userMessagesOnly && userMessagesOnly.checked) || 
            (aiMessagesOnly && aiMessagesOnly.checked) || (systemMessagesOnly && systemMessagesOnly.checked)) {
            const statusMessage = document.createElement('div');
            statusMessage.id = 'searchStatusMessage';
            statusMessage.className = 'alert alert-info mt-2';
            statusMessage.textContent = `Found ${visibleCount} matching message${visibleCount !== 1 ? 's' : ''}.`;
            
            const messageList = document.getElementById('messageList');
            if (messageList) {
                messageList.parentNode.insertBefore(statusMessage, messageList);
            }
        }
    }
    
    function highlightText(element, searchTerm) {
        const innerHTML = element.innerHTML;
        const index = innerHTML.toLowerCase().indexOf(searchTerm.toLowerCase());
        
        if (index >= 0) {
            element.innerHTML = innerHTML.substring(0, index) + 
                              '<span class="message-search-highlight">' + 
                              innerHTML.substring(index, index + searchTerm.length) + 
                              '</span>' + 
                              innerHTML.substring(index + searchTerm.length);
        }
    }
    
    // Charts initialization
    document.addEventListener('DOMContentLoaded', function() {
        // Message Types Chart
        const messageTypeCtx = document.getElementById('messageTypeChart');
        if (messageTypeCtx && typeof Chart !== 'undefined') {
            const messageTypeCounts = {
                user: parseInt(messageTypeCtx.dataset.userMsgs) || 0,
                assistant: parseInt(messageTypeCtx.dataset.aiMsgs) || 0,
                system: parseInt(messageTypeCtx.dataset.systemMsgs) || 0
            };
            
            new Chart(messageTypeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['User', 'Assistant', 'System'],
                    datasets: [{
                        data: [
                            messageTypeCounts.user, 
                            messageTypeCounts.assistant, 
                            messageTypeCounts.system
                        ],
                        backgroundColor: [
                            '#3498db',
                            '#2ecc71',
                            '#f39c12'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    },
                    cutout: '70%'
                }
            });
        }
        
        // Response Time Chart
        const responseTimeCtx = document.getElementById('responseTimeChart');
        if (responseTimeCtx && typeof Chart !== 'undefined') {
            // Generate some sample data for demonstration
            const labels = [];
            const data = [];
            
            for (let i = 1; i <= 10; i++) {
                labels.push(`Message ${i}`);
                data.push((Math.random() * 2) + 1); // Random value between 1-3
            }
            
            new Chart(responseTimeCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Response Time (s)',
                        data: data,
                        borderColor: '#00796B',
                        backgroundColor: 'rgba(0, 121, 107, 0.2)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Seconds'
                            }
                        }
                    }
                }
            });
        }
    });
</script> 