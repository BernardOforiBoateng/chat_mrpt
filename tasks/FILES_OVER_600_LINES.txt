================================================================================
FILES OVER 600 LINES - REFACTORING NEEDED
================================================================================
Date: 2025-10-21
Total Files Over 600 Lines: 71

Target: All files should be under 600 lines per CLAUDE.md guidelines

================================================================================
CRITICAL FILES (Over 2000 lines) - PRIORITY 1
================================================================================

1. visualization_charts_tools.py - 2,643 lines ⚠️ CRITICAL
   Path: app/tools/visualization_charts_tools.py
   Status: Needs major refactoring
   Suggestion: Split into separate chart type modules

2. request_interpreter.py - 2,383 lines ⚠️ CRITICAL
   Path: app/core/request_interpreter.py
   Status: Needs major refactoring
   Suggestion: Split into request parser, response handler, workflow manager

3. analysis_routes.py - 2,238 lines ⚠️ CRITICAL
   Path: app/core/analysis_routes.py
   Status: Needs major refactoring
   Suggestion: Split by analysis type (TPR, risk, ITN, etc.)

4. unified_dataset_builder.py - 2,177 lines ⚠️ CRITICAL (DUPLICATE)
   Path: app/unified_dataset_builder.py
   Status: Needs major refactoring
   NOTE: Duplicate exists at app/data/unified_dataset_builder.py (2,166 lines)

5. unified_dataset_builder.py - 2,166 lines ⚠️ CRITICAL (DUPLICATE)
   Path: app/data/unified_dataset_builder.py
   Status: DUPLICATE - Consolidate with above

6. analysis_routes.py - 2,123 lines ⚠️ CRITICAL
   Path: app/web/routes/analysis_routes.py
   Status: Needs major refactoring
   Suggestion: Split into multiple route files


================================================================================
VERY LARGE FILES (1500-2000 lines) - PRIORITY 2
================================================================================

7. tpr_workflow_handler.py - 1,862 lines
   Path: app/data_analysis_v3/core/tpr_workflow_handler.py

8. complete_analysis_tools.py - 1,790 lines
   Path: app/tools/complete_analysis_tools.py

9. arena_routes.py - 1,581 lines
   Path: app/web/routes/arena_routes.py

10. export_tools.py - 1,522 lines
    Path: app/tools/export_tools.py


================================================================================
LARGE FILES (1000-1500 lines) - PRIORITY 3
================================================================================

11. composite_visualizations.py - 1,473 lines
    Path: app/services/agents/visualizations/composite_visualizations.py

12. conversational_data_access.py - 1,468 lines
    Path: app/services/conversational_data_access.py

13. itn_pipeline.py - 1,467 lines
    Path: app/analysis/itn_pipeline.py

14. tpr_analysis_tool.py - 1,412 lines
    Path: app/data_analysis_v3/tools/tpr_analysis_tool.py

15. tpr_analysis_tool.py - 1,338 lines (DUPLICATE)
    Path: app/data_analysis_v3/tpr_analysis_tool.py

16. __init__.py - 1,250 lines
    Path: app/data/__init__.py

17. arena_manager.py - 1,231 lines
    Path: app/core/arena_manager.py

18. visualization_maps_tools.py - 1,186 lines
    Path: app/tools/visualization_maps_tools.py

19. workflow_manager.py - 1,145 lines
    Path: app/data_analysis_v3/tpr/workflow_manager.py

20. tpr_workflow_langgraph_tool.py - 1,132 lines
    Path: app/data_analysis_v3/tools/tpr_workflow_langgraph_tool.py

21. tpr_workflow_langgraph_tool.py - 1,122 lines (DUPLICATE)
    Path: app/data_analysis_v3/core/tpr_workflow_langgraph_tool.py

22. tool_registry.py - 1,107 lines
    Path: app/core/tool_registry.py

23. visualization_maps_tools.py - 1,039 lines (DUPLICATE)
    Path: app/core/visualization_maps_tools.py

24. arena_manager.py - 1,038 lines (DUPLICATE)
    Path: app/web/routes/arena_manager.py

25. itn_pipeline.py - 1,037 lines (DUPLICATE)
    Path: app/core/itn_pipeline.py

26. settlement_intervention_tools.py - 1,033 lines
    Path: app/tools/settlement_intervention_tools.py

27. questions.py - 1,027 lines
    Path: app/survey/questions.py


================================================================================
MEDIUM FILES (600-1000 lines) - PRIORITY 4
================================================================================

28. events.py - 970 lines (app/interaction/events.py)
29. tpr_analysis_tool.py - 886 lines (app/data_analysis_v3/core/tpr_analysis_tool.py)
30. validation.py - 868 lines (app/data/validation.py)
31. visualization_routes.py - 833 lines (app/web/routes/visualization_routes.py)
32. agent.py - 823 lines (app/data_analysis_v3/core/agent.py)
33. llm_manager.py - 811 lines (app/web/routes/llm_manager.py)
34. nmep_parser.py - 801 lines (app/tpr_module/data/nmep_parser.py)
35. tpr_workflow_handler.py - 798 lines (app/tpr_workflow_handler.py)
36. llm_manager.py - 797 lines (app/core/llm_manager.py)
37. nmep_parser.py - 795 lines (app/tpr_module.backup.20250806/data/nmep_parser.py) - BACKUP
38. tpr_utils.py - 783 lines (app/core/tpr_utils.py)
39. pca_pipeline.py - 782 lines (app/analysis/pca_pipeline.py)
40. tpr_conversation_manager.py - 780 lines (app/tpr_module/core/tpr_conversation_manager.py)
41. tpr_conversation_manager.py - 780 lines (BACKUP) (app/tpr_module.backup.20250806/...)
42. chart_service.py - 780 lines (app/services/visualization/chart_service.py)
43. core_routes.py - 775 lines (app/web/routes/core_routes.py)
44. tpr_handler.py - 766 lines (app/tpr_module/integration/tpr_handler.py)
45. tpr_handler.py - 766 lines (BACKUP) (app/tpr_module.backup.20250806/...)
46. storage.py - 763 lines (app/interaction/storage.py)
47. data_analysis_v3_routes.py - 754 lines (app/web/routes/data_analysis_v3_routes.py)
48. export_tools.py - 753 lines (app/core/export_tools.py)
49. region_aware_selection.py - 735 lines (app/analysis/region_aware_selection.py)
50. analysis.py - 730 lines (app/data/analysis.py)
51. standardized_analysis_tools.py - 724 lines (app/services/tools/...)
52. chatmrpt_help_tool.py - 709 lines (app/tools/chatmrpt_help_tool.py)
53. utils.py - 708 lines (app/runtime/tpr/utils.py)
54. tpr_utils.py - 708 lines (app/data_analysis_v3/core/tpr_utils.py)
55. raster_extractor.py - 701 lines (app/tpr_module/services/raster_extractor.py)
56. raster_extractor.py - 701 lines (BACKUP) (app/tpr_module.backup.20250806/...)
57. container.py - 696 lines (app/services/container.py)
58. reporting.py - 695 lines (app/data/reporting.py)
59. executor.py - 687 lines (app/data_analysis_v3/core/executor.py)
60. llm_adapter.py - 666 lines (app/core/llm_adapter.py)
61. output_generator.py - 665 lines (app/tpr_module/output/output_generator.py)
62. output_generator.py - 665 lines (BACKUP) (app/tpr_module.backup.20250806/...)
63. tpr_data_analyzer.py - 665 lines (app/data_analysis_v3/core/tpr_data_analyzer.py)
64. container.py - 664 lines (app/core/container.py)
65. upload_routes.py - 662 lines (app/web/routes/upload_routes.py)
66. data_analyzer.py - 629 lines (app/data_analysis_v3/tpr/data_analyzer.py)
67. tpr_calculator.py - 628 lines (app/tpr_module/core/tpr_calculator.py)
68. tpr_calculator.py - 628 lines (BACKUP) (app/tpr_module.backup.20250806/...)
69. agent_old_with_tpr.py - 607 lines (app/data_analysis_v3/core/agent_old_with_tpr.py)
70. core.py - 604 lines (app/interaction/core.py)
71. flexible_data_access.py - 604 lines (app/data/flexible_data_access.py)


================================================================================
KEY OBSERVATIONS
================================================================================

1. DUPLICATE FILES FOUND:
   - unified_dataset_builder.py (appears in app/ and app/data/)
   - tpr_analysis_tool.py (appears in multiple locations)
   - visualization_maps_tools.py (appears in app/tools/ and app/core/)
   - arena_manager.py (appears in app/core/ and app/web/routes/)
   - itn_pipeline.py (appears in app/analysis/ and app/core/)
   - tpr_workflow_langgraph_tool.py (appears in tools/ and core/)

2. BACKUP FILES (.backup.20250806):
   - app/tpr_module.backup.20250806/ contains 6 files over 600 lines
   - These should be removed before GitHub commit
   - Already marked in .gitignore plan

3. WORST OFFENDERS (Top 5):
   - visualization_charts_tools.py: 2,643 lines (4.4x over limit)
   - request_interpreter.py: 2,383 lines (4x over limit)
   - analysis_routes.py (core): 2,238 lines (3.7x over limit)
   - unified_dataset_builder.py: 2,177 lines (3.6x over limit)
   - analysis_routes.py (web): 2,123 lines (3.5x over limit)

4. CATEGORIES NEEDING ATTENTION:
   - Tools (visualization, analysis, export): Many over 1000 lines
   - Routes (analysis, arena, visualization): Many over 800 lines
   - Core modules (request_interpreter, arena_manager): Over 1000 lines
   - TPR modules (workflow, analysis, utils): Many over 700 lines


================================================================================
REFACTORING STRATEGY
================================================================================

Given Time Constraint (GitHub commit for tomorrow's review):

OPTION A: Quick Cleanup (Recommended for now)
-----------------------------------------------------------------
Focus on removing duplicates and backups, defer refactoring:

1. Remove duplicate files (choose canonical location)
2. Remove backup files (.backup.20250806)
3. Document large files as "known technical debt"
4. Add TODO comments in files over 1000 lines
5. Commit to GitHub with issue tracking for refactoring

Time Required: 1-2 hours
Files Cleaned: ~15 duplicates/backups
Files Refactored: 0 (deferred)


OPTION B: Moderate Refactoring (If time allows)
-----------------------------------------------------------------
Remove duplicates + refactor worst offenders:

1. Remove duplicates and backups
2. Refactor top 3 critical files (2000+ lines):
   - visualization_charts_tools.py → split into chart modules
   - request_interpreter.py → split into parser + handler
   - unified_dataset_builder.py → remove duplicate, split if needed
3. Document remaining technical debt

Time Required: 4-6 hours
Files Cleaned: ~15 duplicates/backups
Files Refactored: 3 critical files


OPTION C: Comprehensive Refactoring (After GitHub)
-----------------------------------------------------------------
Full refactoring to meet 600-line limit:

1. All of Option B
2. Refactor all files over 1000 lines (27 files)
3. Refactor files 600-1000 lines (44 files)
4. Create proper module structure

Time Required: 20-30 hours
Files Refactored: 71 files


================================================================================
RECOMMENDED IMMEDIATE ACTION
================================================================================

OPTION A: Quick Cleanup for Tomorrow's Review

Step 1: Remove Backup Files (5 minutes)
  rm -rf app/tpr_module.backup.20250806/

Step 2: Remove Duplicate Files (30 minutes)
  Identify canonical location for each duplicate
  Delete duplicate, ensure imports updated

Step 3: Add Technical Debt Markers (15 minutes)
  Add comments at top of files over 1000 lines:
  # TODO: Refactor - File exceeds 600-line guideline (current: XXXX lines)
  # See: tasks/FILES_OVER_600_LINES.txt for refactoring plan

Step 4: Create GitHub Issue Template (10 minutes)
  Document all 71 files as refactoring tasks

Step 5: Commit to GitHub (5 minutes)
  With clear documentation of known technical debt


================================================================================
DUPLICATES TO RESOLVE
================================================================================

Priority Duplicates (Choose One):
-----------------------------------------------------------------

1. unified_dataset_builder.py
   Location A: app/unified_dataset_builder.py (2,177 lines)
   Location B: app/data/unified_dataset_builder.py (2,166 lines)
   RECOMMENDATION: Keep app/data/unified_dataset_builder.py (proper location)

2. tpr_analysis_tool.py
   Location A: app/data_analysis_v3/tools/tpr_analysis_tool.py (1,412 lines)
   Location B: app/data_analysis_v3/tpr_analysis_tool.py (1,338 lines)
   Location C: app/data_analysis_v3/core/tpr_analysis_tool.py (886 lines)
   RECOMMENDATION: Keep app/data_analysis_v3/tools/ (canonical tools location)

3. visualization_maps_tools.py
   Location A: app/tools/visualization_maps_tools.py (1,186 lines)
   Location B: app/core/visualization_maps_tools.py (1,039 lines)
   RECOMMENDATION: Keep app/tools/ (proper location for tools)

4. arena_manager.py
   Location A: app/core/arena_manager.py (1,231 lines)
   Location B: app/web/routes/arena_manager.py (1,038 lines)
   RECOMMENDATION: Keep app/core/ (manager belongs in core, not routes)

5. itn_pipeline.py
   Location A: app/analysis/itn_pipeline.py (1,467 lines)
   Location B: app/core/itn_pipeline.py (1,037 lines)
   RECOMMENDATION: Keep app/analysis/ (proper location for pipelines)

6. tpr_workflow_langgraph_tool.py
   Location A: app/data_analysis_v3/tools/tpr_workflow_langgraph_tool.py (1,132)
   Location B: app/data_analysis_v3/core/tpr_workflow_langgraph_tool.py (1,122)
   RECOMMENDATION: Keep app/data_analysis_v3/tools/ (tools location)


Backup Files to DELETE:
-----------------------------------------------------------------
- app/tpr_module.backup.20250806/ (entire directory)
  Contains 6 files totaling ~4,400 lines


================================================================================
NEXT STEPS
================================================================================

For Tomorrow's Review:
1. Choose Option A (Quick Cleanup)
2. Remove backups: rm -rf app/tpr_module.backup.20250806/
3. Resolve 6 duplicate files (keep canonical, delete duplicate)
4. Add TODO markers to files over 1000 lines
5. Proceed with GitHub cleanup and commit

After GitHub Commit:
1. Create refactoring roadmap
2. Break down large files systematically
3. Implement modular architecture
4. Add unit tests for refactored modules


================================================================================
END OF REPORT
================================================================================
