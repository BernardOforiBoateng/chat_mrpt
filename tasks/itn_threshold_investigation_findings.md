# ITN Threshold Control & Map Rendering Investigation Findings

## Issue Summary
1. **Threshold Control Not Working**: When users change the urban threshold and click Update, the map does not refresh with the new threshold applied
2. **Missing Areas on Map**: Some geographic areas are missing from the ITN distribution map entirely

## Investigation Results

### 1. Threshold Control Problem

#### Root Cause 1: Hard-coded Values in JavaScript
The `updateThreshold()` function in the generated HTML maps has hard-coded values that don't match the original ITN planning parameters:

```javascript
// Found in generated maps - values differ per map
body: JSON.stringify({
    urban_threshold: parseFloat(newThreshold),
    total_nets: 2000000,  // HARD-CODED - wrong!
    avg_household_size: 4, // HARD-CODED - wrong!
    method: 'composite'
})
```

**Problem**: Each generated map has different hard-coded values (2000000, 9000000, 500000, etc.) instead of using the original values from the ITN planning request.

#### Root Cause 2: Page Reload Strategy
The JavaScript function uses `window.location.reload()` after successful API call:
```javascript
if (data.status === 'success') {
    // Reload page with new map
    window.location.reload();  // This reloads the SAME static HTML file!
}
```

**Problem**: Since the map is served as a static HTML file in an iframe, reloading the page just reloads the same static file with the original threshold value baked in. The new map generated by the backend is never displayed.

#### Root Cause 3: No Session Context
The update request doesn't pass the session_id or reference the correct context:
- No session_id passed to maintain state
- No way to retrieve the original ITN planning parameters
- New map file created but never referenced

### 2. Missing Areas Problem

#### Root Cause: Ward Name Matching Failures
The ITN pipeline performs fuzzy matching between three datasets:
1. **Analysis rankings** (from the vulnerability analysis)
2. **Population data** (from PBI distribution files) 
3. **Shapefile data** (geographic boundaries)

The matching process at line 341-402 in `itn_pipeline.py`:
```python
# Line 399: Remove wards without population data
rankings = rankings[rankings['Population'].notna()]

# Line 401: If no wards left after filtering
if len(rankings) == 0:
    return {'status': 'error', ...}
```

**Problems Found**:
1. **Population Data Matching**: If ward names don't match between the analysis data and population data, those wards are removed (line 399)
2. **Geometry Filtering**: Additional filtering happens at lines 686-690 where wards with invalid geometries are removed
3. **Case Sensitivity**: Ward names need case-insensitive matching but inconsistencies exist
4. **No Fallback**: Wards without population data are completely excluded rather than using a default or estimate

#### Evidence from Code:
- Line 345-402: Fuzzy matching between ranking and population ward names with 75% threshold
- Line 399: `rankings = rankings[rankings['Population'].notna()]` removes unmatched wards
- Line 686-690: `shp_data = shp_data[shp_data['geometry'].notna()]` removes invalid geometries
- Line 584-588: Left join means wards in shapefile without allocation data show as empty

## Impact Analysis

### Threshold Control Impact
- Users cannot dynamically adjust the urban/rural threshold to see different allocation scenarios
- The threshold parameter exists throughout the backend but is ineffective due to frontend issues
- Users must re-run the entire ITN planning with different parameters instead of adjusting interactively

### Missing Areas Impact  
- Wards that don't match between datasets are completely missing from the map
- This could exclude high-risk areas from ITN distribution planning
- Visual representation is incomplete, potentially misleading decision-makers

## Recommended Fixes

### Fix 1: Dynamic Threshold Updates
1. **Store Original Parameters**: Save the original ITN planning parameters (total_nets, avg_household_size) in the session
2. **Fix JavaScript Function**: 
   - Pass session_id with the update request
   - Retrieve original parameters from session
   - Update the iframe src to point to the new map file instead of reloading
3. **Implement Map Replacement**: Instead of `window.location.reload()`, update the iframe src dynamically

### Fix 2: Handle Missing Wards
1. **Preserve All Shapefile Wards**: Keep all geographic boundaries even if no data
2. **Add Default Population**: Use ward area and density estimates for missing population data
3. **Visual Indicators**: Show unmatched wards with a different style (e.g., hatched pattern) 
4. **Improve Matching**: Lower fuzzy matching threshold or implement multi-pass matching
5. **Add Validation Report**: Generate a report showing which wards couldn't be matched

### Fix 3: Session-Aware Updates
1. **Pass Session Context**: Include session_id in all ITN update requests
2. **Maintain State**: Store ITN parameters in Redis or session for multi-worker consistency
3. **Reference Correct Files**: Ensure updated maps reference the correct session's data

## Next Steps
1. Implement Fix 1 to enable dynamic threshold updates
2. Implement Fix 2 to show all geographic areas
3. Add comprehensive logging for ward matching process
4. Create user-facing warnings when wards can't be matched