ChatMRPT Unified Agent Migration – Implementation Report

Date: 2025-10-03

Summary
- Consolidated to a single streaming endpoint: /api/unified/chat-stream
- Activated always-on LangGraph agent across all phases and tabs
- Implemented dynamic CSV↔SHP joins with stable WardUID and join audits
- Converted TPR to agent tools; removed route-side TPR bridging
- Registered risk, viz, ITN, query, methodology, and arena tools
- Updated frontend to stream via unified endpoint

Endpoints
- Streaming (canonical): POST /api/unified/chat-stream (SSE)
- Non-stream JSON (Data Analysis V3): POST /api/v1/data-analysis/chat

Key Changes
1) Agent
   - app/data_analysis_v3/core/agent.py: phase-aware data selection, shapefile summary, tool registry, streaming
   - app/data_analysis_v3/core/state_manager.py: added RISK_ANALYSIS, ITN_PLANNING

2) Dynamic Spatial Joins
   - app/data_analysis_v3/core/spatial_merge.py: suggest_join_plans, merge_detect_and_join, build_join_id
   - app/data_analysis_v3/tools/python_tool.py: exposed shp_df, merge_on_ward, suggest_spatial_joins, build_join_id

3) Tools (LangGraph)
   - Risk: app/data_analysis_v3/tools/risk_analysis_tools.py::run_risk_analysis
   - Visualization: app/data_analysis_v3/tools/visualization_tools.py::{create_vulnerability_map, create_pca_map, create_box_plot, create_variable_distribution}
   - ITN: app/data_analysis_v3/tools/itn_planning_tools.py::plan_itn_distribution (direct pipeline, no interpreter)
   - Query: app/data_analysis_v3/tools/query_tools.py::{execute_sql_query, execute_data_query}
   - Methodology: app/data_analysis_v3/tools/methodology_tools.py::explain_methodology
   - TPR: app/data_analysis_v3/tools/tpr_workflow_tools.py::{start_tpr_workflow, select_tpr_state, select_facility_level, select_age_group, calculate_ward_tpr, prepare_for_risk_analysis}
   - Arena: app/data_analysis_v3/tools/arena_tools.py::compare_model_responses
   - Exports: app/data_analysis_v3/tools/__init__.py

4) Routes (SSE)
   - app/web/routes/unified_agent_routes.py: /api/unified/chat, /api/unified/chat-stream
   - app/web/routes/data_analysis_v3_routes.py: removed TPR bridge; kept JSON chat; removed DA V3 streaming
   - app/web/routes/__init__.py: registered unified routes

5) Frontend
   - frontend/src/hooks/useMessageStreaming.ts: switched to /api/unified/chat-stream
   - frontend/src/services/api.ts: sendMessageStreaming uses unified endpoint
   - frontend/vite.config.ts: removed legacy /send_message_streaming proxy entry

Removed / Deprecated
- /send_message_streaming (main chat): removed
- /api/v1/data-analysis/chat-stream: removed in favor of /api/unified/chat-stream
- TPR route-bridge logic: removed; handled by agent tools

Notes on RequestInterpreter
- Not the orchestrator anymore. Some wrappers previously depended on it; ITN and variable distribution wrappers now call pipeline/tools directly. Remaining wrappers rely on services and do not require the interpreter. Interpreter can be archived once confirmed no other codepaths depend on it at runtime.

Testing Guidance
- curl -N -H "Content-Type: application/json" -d '{"message":"hello","session_id":"<id>"}' http://localhost:5000/api/unified/chat-stream
- Typical flows:
  • Data Analysis Tab: start_tpr_workflow → selections → prepare_for_risk_analysis → run_risk_analysis → create_vulnerability_map → plan_itn_distribution
  • Standard Upload: CSV+SHP → run_risk_analysis → viz → plan_itn_distribution
  • Ad-hoc SHP/CSV: "suggest join plans" → "merge them and show unmatched count"

Operational Notes
- SSE events: {start, delta, tool_start, tool_end, viz, end, error}
- Agent keeps geometry out of prompt; shapefile summarization only
- Join strategy audited; stable WardUID persists across outputs

Open Items (optional)
- Arena UI wiring (agent-driven only; no toggles)
- Archive RequestInterpreter after final verification
- Update scripts/tests that reference legacy endpoints if needed

