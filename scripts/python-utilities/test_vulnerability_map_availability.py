#!/usr/bin/env python3
"""
Test that CreateVulnerabilityMap tool is available and can be discovered
"""

import sys
import os

# Add the project root to the Python path
sys.path.insert(0, '/mnt/c/Users/bbofo/OneDrive/Desktop/ChatMRPT')

# Set environment to avoid loading heavy models during test
os.environ['DISABLE_TOOL_SCORING'] = 'true'

def test_vulnerability_map_tool_exists():
    """Test that the vulnerability map tool can be imported"""
    try:
        from app.tools.visualization_maps_tools import CreateVulnerabilityMap
        print("✅ CreateVulnerabilityMap tool can be imported")

        # Check if it has the required methods
        assert hasattr(CreateVulnerabilityMap, 'execute'), "Missing execute method"
        assert hasattr(CreateVulnerabilityMap, 'get_category'), "Missing get_category method"
        assert hasattr(CreateVulnerabilityMap, 'get_examples'), "Missing get_examples method"

        # Check examples
        examples = CreateVulnerabilityMap.get_examples()
        print(f"✅ Tool has {len(examples)} usage examples:")
        for ex in examples:
            print(f"   - {ex}")

        return True
    except Exception as e:
        print(f"❌ Failed to import CreateVulnerabilityMap: {e}")
        return False

def test_tool_registry_discovery():
    """Test that the tool registry can discover the vulnerability map tool"""
    try:
        from app.core.tool_registry import ToolRegistry

        registry = ToolRegistry()

        # Discover tools
        num_tools = registry.discover_tools()
        print(f"✅ Tool registry discovered {num_tools} tools")

        # Check if vulnerability map is in the registry
        all_tools = registry.get_all_tools()

        # Look for vulnerability map tool
        found = False
        for tool_name, tool_class in all_tools.items():
            if 'vulnerability' in tool_name.lower() and 'map' in tool_name.lower():
                print(f"✅ Found vulnerability map tool: {tool_name}")
                found = True
                break

        if not found:
            # List all visualization tools
            print("\nAvailable visualization tools:")
            for tool_name in all_tools.keys():
                if 'map' in tool_name.lower() or 'viz' in tool_name.lower():
                    print(f"  - {tool_name}")

        return found
    except Exception as e:
        print(f"❌ Tool registry test failed: {e}")
        import traceback
        traceback.print_exc()
        return False

def test_message_content():
    """Test that the message mentions vulnerability map when PCA is skipped"""
    try:
        # Read the complete analysis tool file
        file_path = '/mnt/c/Users/bbofo/OneDrive/Desktop/ChatMRPT/app/tools/complete_analysis_tools.py'
        with open(file_path, 'r') as f:
            content = f.read()

        # Check for vulnerability map mention in the message
        if "Create vulnerability map" in content:
            print("✅ Message mentions vulnerability map option")

            # Find the specific line
            for i, line in enumerate(content.split('\n'), 1):
                if "Create vulnerability map" in line:
                    print(f"   Found at line {i}: {line.strip()[:80]}...")
                    break
            return True
        else:
            print("❌ Message doesn't mention vulnerability map")
            return False
    except Exception as e:
        print(f"❌ Failed to check message content: {e}")
        return False

if __name__ == "__main__":
    print("="*60)
    print("Testing Vulnerability Map Availability")
    print("="*60)

    results = []

    print("\n1. Testing tool import...")
    results.append(test_vulnerability_map_tool_exists())

    print("\n2. Testing tool registry discovery...")
    results.append(test_tool_registry_discovery())

    print("\n3. Testing message content...")
    results.append(test_message_content())

    print("\n" + "="*60)
    if all(results):
        print("✅ ALL TESTS PASSED")
        print("Users can request vulnerability maps when PCA is skipped!")
    else:
        print("⚠️ SOME TESTS FAILED")
        print("Please check the implementation")
    print("="*60)