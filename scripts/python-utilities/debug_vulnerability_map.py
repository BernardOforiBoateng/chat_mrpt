#!/usr/bin/env python3
"""Debug script to test vulnerability map geometry handling"""

import json
import logging
import sys
import os
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

import geopandas as gpd
import pandas as pd
import numpy as np
from shapely.geometry import Polygon, Point
import plotly.graph_objects as go

# Set up logging
logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)

def test_null_geometry_handling():
    """Test how null geometries are handled in GeoJSON conversion"""
    
    # Create test data with some null geometries
    data = {
        'WardName': ['Ward1', 'Ward2', 'Ward3', 'Ward4', 'Ward5'],
        'composite_score': [0.8, 0.6, 0.9, 0.4, 0.7],
        'composite_rank': [2, 4, 1, 5, 3],
        'vulnerability_category': ['High', 'Medium', 'Very High', 'Low', 'High']
    }
    
    # Create geometries with one null
    geometries = [
        Polygon([(0, 0), (1, 0), (1, 1), (0, 1)]),
        Polygon([(1, 0), (2, 0), (2, 1), (1, 1)]),
        None,  # Null geometry
        Polygon([(0, 1), (1, 1), (1, 2), (0, 2)]),
        Polygon([(1, 1), (2, 1), (2, 2), (1, 2)])
    ]
    
    # Create GeoDataFrame
    gdf = gpd.GeoDataFrame(data, geometry=geometries, crs='EPSG:4326')
    
    logger.info(f"Created GeoDataFrame with {len(gdf)} rows")
    logger.info(f"Null geometries: {gdf.geometry.isnull().sum()}")
    
    # Test 1: Direct to_json conversion
    try:
        geojson_direct = json.loads(gdf.to_json())
        logger.info("Direct to_json conversion succeeded")
        
        # Check features
        for i, feature in enumerate(geojson_direct['features']):
            if feature['geometry'] is None:
                logger.warning(f"Feature {i} has null geometry")
    except Exception as e:
        logger.error(f"Direct to_json conversion failed: {e}")
    
    # Test 2: Filter null geometries before conversion
    try:
        valid_mask = ~gdf.geometry.isnull()
        gdf_valid = gdf[valid_mask].copy()
        logger.info(f"After filtering: {len(gdf_valid)} valid geometries")
        
        geojson_filtered = json.loads(gdf_valid.to_json())
        logger.info("Filtered to_json conversion succeeded")
        
        # Test with Plotly
        fig = go.Figure()
        fig.add_trace(go.Choroplethmapbox(
            geojson=geojson_filtered,
            locations=gdf_valid.index,
            z=gdf_valid['composite_score'],
            colorscale='Plasma_r',
            marker_opacity=0.8,
            marker_line_width=0.5,
            marker_line_color='black',
            showscale=True
        ))
        
        fig.update_layout(
            mapbox=dict(
                style="open-street-map",
                center={"lat": 1, "lon": 1},
                zoom=8
            ),
            margin=dict(l=0, r=0, t=0, b=0)
        )
        
        # Save to test file
        fig.write_html('test_vulnerability_map.html')
        logger.info("Plotly map created successfully")
        
    except Exception as e:
        logger.error(f"Filtered conversion or Plotly creation failed: {e}")
        import traceback
        traceback.print_exc()

    # Test 3: Check what happens with empty geometries
    try:
        # Create an empty polygon
        empty_geom = Polygon()
        logger.info(f"Empty polygon is_empty: {empty_geom.is_empty}")
        logger.info(f"Empty polygon is_valid: {empty_geom.is_valid}")
        
    except Exception as e:
        logger.error(f"Empty geometry test failed: {e}")

if __name__ == "__main__":
    test_null_geometry_handling()