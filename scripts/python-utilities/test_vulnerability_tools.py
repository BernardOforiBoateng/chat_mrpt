#!/usr/bin/env python3
"""
Test that both vulnerability map tools are available and properly configured
"""

import sys
import os

# Add the project root to the Python path
sys.path.insert(0, '/mnt/c/Users/bbofo/OneDrive/Desktop/ChatMRPT')

# Set environment to avoid loading heavy models during test
os.environ['DISABLE_TOOL_SCORING'] = 'true'

def test_both_tools_exist():
    """Test that both vulnerability map tools can be imported"""
    try:
        from app.tools.visualization_maps_tools import CreateVulnerabilityMap, CreateVulnerabilityMapComparison
        print("✅ Both tools can be imported:")
        print("   - CreateVulnerabilityMap (for single method)")
        print("   - CreateVulnerabilityMapComparison (for side-by-side comparison)")
        return True
    except Exception as e:
        print(f"❌ Failed to import tools: {e}")
        return False

def test_tools_in_init():
    """Test that both tools are exported from __init__.py"""
    try:
        from app.tools import CreateVulnerabilityMap, CreateVulnerabilityMapComparison
        print("✅ Both tools are exported from app.tools module")
        return True
    except ImportError as e:
        print(f"❌ Tools not properly exported: {e}")
        return False

def test_message_logic():
    """Test that the message properly shows different options based on PCA status"""
    try:
        # Read the complete analysis tool file
        file_path = '/mnt/c/Users/bbofo/OneDrive/Desktop/ChatMRPT/app/tools/complete_analysis_tools.py'
        with open(file_path, 'r') as f:
            content = f.read()

        # Check for conditional logic
        if 'if not pca_result.get("pca_skipped")' in content:
            print("✅ Conditional logic for PCA skip found")

            # Check for both options
            if 'create vulnerability map comparison' in content.lower():
                print("   ✅ Comparison option available when PCA passes")
            else:
                print("   ❌ Comparison option missing")

            if 'Show composite risk levels' in content:
                print("   ✅ Composite-only option for when PCA is skipped")
            else:
                print("   ❌ Composite-only option missing")

            return True
        else:
            print("❌ No conditional logic found for PCA skip")
            return False
    except Exception as e:
        print(f"❌ Failed to check message logic: {e}")
        return False

def test_tool_registry():
    """Test that both tools are registered in the tool registry"""
    try:
        from app.core.tool_registry import ToolRegistry

        registry = ToolRegistry()
        num_tools = registry.discover_tools()

        all_tools = registry.get_all_tools()

        found_single = False
        found_comparison = False

        for tool_name, tool_class in all_tools.items():
            if 'vulnerabilitymap' in tool_name.lower() and 'comparison' not in tool_name.lower():
                print(f"✅ Found single vulnerability map tool: {tool_name}")
                found_single = True
            elif 'vulnerabilitymapcomparison' in tool_name.lower():
                print(f"✅ Found comparison vulnerability map tool: {tool_name}")
                found_comparison = True

        return found_single and found_comparison
    except Exception as e:
        print(f"❌ Tool registry test failed: {e}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == "__main__":
    print("="*60)
    print("Testing Vulnerability Map Tools Configuration")
    print("="*60)

    results = []

    print("\n1. Testing tool imports from visualization_maps_tools...")
    results.append(test_both_tools_exist())

    print("\n2. Testing tool exports from __init__.py...")
    results.append(test_tools_in_init())

    print("\n3. Testing message logic for PCA skip...")
    results.append(test_message_logic())

    print("\n4. Testing tool registry discovery...")
    results.append(test_tool_registry())

    print("\n" + "="*60)
    if all(results):
        print("✅ ALL TESTS PASSED")
        print("\nConfiguration:")
        print("- When PCA passes: Users can create comparison maps or individual maps")
        print("- When PCA is skipped: Users can create composite-only vulnerability maps")
    else:
        print("⚠️ SOME TESTS FAILED")
        print("Please check the implementation")
    print("="*60)