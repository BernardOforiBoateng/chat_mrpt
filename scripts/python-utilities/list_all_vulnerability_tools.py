#!/usr/bin/env python3
"""
List all vulnerability map tools and their registration details
"""

import sys
import os

# Add the project root to the Python path
sys.path.insert(0, '/mnt/c/Users/bbofo/OneDrive/Desktop/ChatMRPT')

# Set environment to avoid loading heavy models
os.environ['DISABLE_TOOL_SCORING'] = 'true'
os.environ['TESTING'] = 'true'

def investigate_tools():
    """Report on all vulnerability map tools"""
    print("="*80)
    print("VULNERABILITY MAP TOOLS INVESTIGATION REPORT")
    print("="*80)

    # Import the tools
    from app.tools.visualization_maps_tools import (
        CreateVulnerabilityMap,
        CreateVulnerabilityMapComparison,
        CreatePCAMap,
        CreateCompositeScoreMaps,
        CreateBoxPlot
    )

    # Import the registry
    from app.core.tool_registry import ToolRegistry

    tools_to_check = [
        CreateVulnerabilityMap,
        CreateVulnerabilityMapComparison,
        CreatePCAMap,
        CreateCompositeScoreMaps,
        CreateBoxPlot
    ]

    print("\n1. TOOL CLASSES AND THEIR REGISTERED NAMES:")
    print("-" * 50)
    for tool in tools_to_check:
        name = tool.get_tool_name()
        desc = tool.get_description()[:100] + "..." if len(tool.get_description()) > 100 else tool.get_description()
        print(f"\nClass: {tool.__name__}")
        print(f"  Registered Name: '{name}'")
        print(f"  Description: {desc}")

    print("\n\n2. TOOLS DISCOVERED BY REGISTRY:")
    print("-" * 50)
    registry = ToolRegistry()
    registry.discover_tools()
    all_tools = registry.list_tools()

    # Filter for vulnerability-related tools
    vuln_tools = [t for t in all_tools if 'vulnerab' in t.lower() or 'composite' in t.lower() or 'pca' in t.lower()]

    print(f"Total tools in registry: {len(all_tools)}")
    print(f"Vulnerability-related tools found: {len(vuln_tools)}")
    print("\nVulnerability tools in registry:")
    for tool_name in sorted(vuln_tools):
        metadata = registry.get_tool_metadata(tool_name)
        if metadata:
            print(f"  - '{tool_name}': {metadata.description[:80]}...")

    print("\n\n3. WHAT EACH TOOL DOES:")
    print("-" * 50)

    print("\nüìç CreateVulnerabilityMap (registered as 'createvulnerabilitymap'):")
    print("  - Creates vulnerability maps for COMPOSITE method")
    print("  - Uses create_agent_vulnerability_map() from app.services.agents.visualizations")
    print("  - Creates choropleth maps showing wards colored by risk categories")

    print("\nüìç CreateVulnerabilityMapComparison (registered as 'create_vulnerability_map_comparison'):")
    print("  - Creates SIDE-BY-SIDE comparison of BOTH methods (Composite AND PCA)")
    print("  - This is the tool for showing both methods together")
    print("  - Default view when users ask for vulnerability maps without specifying method")
    print("  - NOTE: Overrides get_tool_name() to use underscores")

    print("\nüìç CreatePCAMap (registered as 'createpcamap'):")
    print("  - Creates vulnerability maps for PCA method only")
    print("  - Uses create_agent_pca_vulnerability_map() from app.services.agents.visualizations")

    print("\nüìç CreateCompositeScoreMaps (registered as 'createcompositescoremaps'):")
    print("  - Creates composite score maps showing INDIVIDUAL MODEL BREAKDOWNS")
    print("  - Uses create_agent_composite_score_maps() for paginated model visualization")
    print("  - Shows how different models contribute to the composite score")

    print("\n\n4. MISSING TOOLS:")
    print("-" * 50)
    print("‚ùå NO tool called 'CreateVulnerabilityMapSimple' exists in the codebase")
    print("‚ùå Git history search shows no previous existence of 'VulnerabilityMapSimple'")

    print("\n\n5. CURRENT TOOL MAPPING:")
    print("-" * 50)
    print("For SIDE-BY-SIDE comparison (both methods): use 'create_vulnerability_map_comparison'")
    print("For COMPOSITE method only: use 'createvulnerabilitymap'")
    print("For PCA method only: use 'createpcamap'")
    print("For COMPOSITE with model breakdowns: use 'createcompositescoremaps'")

    print("\n" + "="*80)
    print("END OF INVESTIGATION REPORT")
    print("="*80)

if __name__ == "__main__":
    investigate_tools()